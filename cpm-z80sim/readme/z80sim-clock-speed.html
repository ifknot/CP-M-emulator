<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=windows-1252"/>
	<title></title>
	<meta name="generator" content="LibreOffice 7.3.2.2 (Windows)"/>
	<meta name="created" content="2022-09-25T17:49:20.504000000"/>
	<meta name="changed" content="2022-09-25T17:50:43.517000000"/>
	<style type="text/css">
		@page { size: 21cm 29.7cm; margin: 2cm }
		p { line-height: 115%; margin-bottom: 0.25cm; background: transparent }
		h1 { margin-bottom: 0.21cm; background: transparent; page-break-after: avoid }
		h1.western { font-family: "Liberation Serif", serif; font-size: 24pt; font-weight: bold }
		h1.cjk { font-family: "NSimSun"; font-size: 24pt; font-weight: bold }
		h1.ctl { font-family: "Arial"; font-size: 24pt; font-weight: bold }
		h2 { margin-top: 0.35cm; margin-bottom: 0.21cm; background: transparent; page-break-after: avoid }
		h2.western { font-family: "Liberation Serif", serif; font-size: 18pt; font-weight: bold }
		h2.cjk { font-family: "NSimSun"; font-size: 18pt; font-weight: bold }
		h2.ctl { font-family: "Arial"; font-size: 18pt; font-weight: bold }
		a:link { color: #000080; so-language: zxx; text-decoration: underline }
	</style>
</head>
<body lang="en-GB" link="#000080" vlink="#800000" dir="ltr"><h1 class="western" style="text-transform: uppercase; font-weight: normal; line-height: 109%; margin-top: 0cm; margin-bottom: 0.32cm; border: none; padding: 0cm">
<font face="inherit"><font size="6" style="font-size: 24pt">Z80SIM
CLOCK SPEED</font></font></h1>
<h1 class="western" style="text-transform: uppercase; font-weight: normal; line-height: 109%; margin-top: 0cm; margin-bottom: 0.32cm; border: none; padding: 0cm">
<font face="inherit"><font size="6" style="font-size: 24pt"><span style="font-variant: normal"><font color="#000000"><font size="6" style="font-size: 24pt"><span style="letter-spacing: normal"><span style="font-style: normal">SYDNEYSMITH.COM</span></span></font></font></span></font></font></h1>
<p style="line-height: 133%; margin-right: 0.26cm"><span style="display: inline-block; border: none; padding: 0cm"><span style="text-transform: uppercase"><font color="#767676"><span style="text-decoration: none"><font face="inherit"><font size="2" style="font-size: 9pt"><span style="font-weight: normal"><span style="background: #ffffff"><a href="https://www.sydneysmith.com/wordpress/1822/z80sim-clock-speed/">5
JAN 18</span></span></font></font></span></font></span></a><font color="#767676"><font face="inherit"><font size="2" style="font-size: 9pt"><span style="font-weight: normal"><span style="background: #ffffff"><span style="text-transform: uppercase">&nbsp;</span></span></font></font></font></span><span style="text-transform: uppercase"><font color="#767676"><span style="text-decoration: none"><font face="inherit"><font size="2" style="font-size: 9pt"><span style="font-weight: normal"><span style="background: #ffffff"><a href="https://www.sydneysmith.com/wordpress/author/greg/">GREG</span></span></font></font></span></font></span></a><font color="#767676"><font face="inherit"><font size="2" style="font-size: 9pt"><span style="font-weight: normal"><span style="background: #ffffff"><span style="text-transform: uppercase">&nbsp;</span></span></font></font></font></span><span style="text-transform: uppercase"><font color="#767676"><span style="text-decoration: none"><font face="inherit"><font size="2" style="font-size: 9pt"><span style="font-weight: normal"><span style="background: #ffffff"><a href="https://www.sydneysmith.com/wordpress/1822/z80sim-clock-speed/#respond">LEAVE
A COMMENT</span></span></span></font></font></span></font></span></a></p>
<p style="font-variant: normal; letter-spacing: normal; orphans: 2; widows: 2; margin-left: 1.43cm; margin-right: 1.43cm; margin-bottom: 0cm; border: none; padding: 0cm">
<span style="display: inline-block; border: none; padding: 0cm"><u><span style="background: #ffffff"><font color="#24890d"><a href="http://www.sydneysmith.com/wordpress/wp-content/uploads/2018/01/z80sim-usage.png">
  <img src="z80sin-clock-speed_html_8dac0ef1a76fff3a.png" name="Image1" align="bottom" width="627" height="315" border="0"/>
</a>
</span></span></u></font></p>
<p style="font-variant: normal; letter-spacing: normal; font-style: normal; font-weight: normal; orphans: 2; widows: 2; margin-left: 1.43cm; margin-right: 1.43cm; margin-bottom: 0.64cm; border: none; padding: 0cm">
<span style="display: inline-block; border: none; padding: 0cm"><font face="inherit"><font size="3" style="font-size: 12pt"><span style="background: #ffffff"><font color="#2b2b2b">The
z80sim program always had a command line option to set clock speed. I
can&rsquo;t say that I expected it to work though. That&rsquo;s not a
comment on Udo, who wrote and maintains the original software. It&rsquo;s
a comment on things that got removed by me when I did the Windows
build. There were a number of things using very nicely written unix
timers that were never going to work in a pure Windows environment.
(I&rsquo;m told that cygwin adds all of the needed unix support &ndash;
a great plus &ndash; but there seems to be a lot of it to download,
install and configure; a bit of a minus.)</span></span></font></font></font></p>
<p style="font-variant: normal; letter-spacing: normal; font-style: normal; font-weight: normal; orphans: 2; widows: 2; margin-left: 1.43cm; margin-right: 1.43cm; margin-bottom: 0.64cm; border: none; padding: 0cm"><a name="more-1822"></a>
<span style="display: inline-block; border: none; padding: 0cm"><font face="inherit"><font size="3" style="font-size: 12pt"><span style="background: #ffffff"><font color="#2b2b2b">To
my surprise, despite what I&rsquo;d initially removed to get z80sim
running, the -f option for CPU frequency works just fine.</span></span></font></font></font></p>
<p style="orphans: 2; widows: 2; margin-left: 1.43cm; margin-right: 1.43cm; margin-bottom: 0cm; border: none; padding: 0cm">
<span style="display: inline-block; border: none; padding: 0cm"><font color="#2b2b2b"><font face="inherit"><font size="3" style="font-size: 12pt"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal"><span style="background: #ffffff"><span style="font-variant: normal">It
effectively adds wait states every so often to slow the emulation
down to the required speed. It&rsquo;s not dissimilar to what I did
to&nbsp;</span></span></span></span></font></font></font></span><span style="font-variant: normal"><font color="#24890d"><font face="inherit"><font size="3" style="font-size: 12pt"><span style="letter-spacing: normal"><span style="font-style: normal"><u><span style="font-weight: normal"><span style="background: #ffffff"><a href="http://www.sydneysmith.com/wordpress/1804/spending-15-minutes-in-a-microsecond/">reduce
host CPU usage when idle</span></span></u></span></span></font></font></font></span></a><font color="#2b2b2b"><font face="inherit"><font size="3" style="font-size: 12pt"><span style="letter-spacing: normal"><span style="font-style: normal"><span style="font-weight: normal"><span style="background: #ffffff"><span style="font-variant: normal">.
The code uses timeofday functions and a nanosleep() call. The
timeofday stuff transfers to Windows easily (as is). I&rsquo;d never
thought nanosleep() would though &ndash; Windows doesn&rsquo;t have
the precision for it. It didn&rsquo;t come up as a compiler or link
error when I built the executable so I missed that it was even there.
Here it is running:</span></span></span></span></span></font></font></font></span></p>
<p style="font-variant: normal; letter-spacing: normal; orphans: 2; widows: 2; margin-left: 1.43cm; margin-right: 1.43cm; margin-bottom: 0cm; border: none; padding: 0cm">
<span style="display: inline-block; border: none; padding: 0cm"><u><span style="background: #ffffff"><font color="#24890d"><a href="http://www.sydneysmith.com/wordpress/wp-content/uploads/2018/01/z80sim-4MHz.png">
  <img src="z80sin-clock-speed_html_4469b72aab0da0b.png" name="Image2" align="bottom" width="627" height="420" border="0"/>
</a>
</span></span></u></font></p>
<p style="font-variant: normal; letter-spacing: normal; font-style: normal; font-weight: normal; orphans: 2; widows: 2; margin-left: 1.43cm; margin-right: 1.43cm; margin-bottom: 0.64cm; border: none; padding: 0cm">
<span style="display: inline-block; border: none; padding: 0cm"><font face="inherit"><font size="3" style="font-size: 12pt"><span style="background: #ffffff"><font color="#2b2b2b">It
starts up slower and displays things slower so it does look like
nanosleep() isn&rsquo;t just returning immediately. Nice.</span></span></font></font></font></p>
<h2 class="western" style="font-variant: normal; letter-spacing: normal; font-style: normal; line-height: 100%; orphans: 2; widows: 2; margin-left: 1.43cm; margin-right: 1.43cm; margin-top: 0.95cm; margin-bottom: 0.32cm; border: none; padding: 0cm">
<span style="display: inline-block; border: none; padding: 0cm"><font face="inherit"><font size="5" style="font-size: 18pt"><b><span style="background: #ffffff"><font color="#2b2b2b">Full
Speed</span></span></b></font></font></font></h2>
<p style="font-variant: normal; letter-spacing: normal; font-style: normal; font-weight: normal; orphans: 2; widows: 2; margin-left: 1.43cm; margin-right: 1.43cm; margin-bottom: 0.64cm; border: none; padding: 0cm">
<span style="display: inline-block; border: none; padding: 0cm"><font face="inherit"><font size="3" style="font-size: 12pt"><span style="background: #ffffff"><font color="#2b2b2b">If
4 MHz is slower, how fast does it run normally?</span></span></font></font></font></p>
<p style="font-variant: normal; letter-spacing: normal; font-style: normal; font-weight: normal; orphans: 2; widows: 2; margin-left: 1.43cm; margin-right: 1.43cm; margin-bottom: 0.64cm; border: none; padding: 0cm">
<span style="display: inline-block; border: none; padding: 0cm"><font face="inherit"><font size="3" style="font-size: 12pt"><span style="background: #ffffff"><font color="#2b2b2b">The
start up banner usually says, &ldquo;CPU speed is unlimited&rdquo;.
If it&rsquo;s unlimited, what&rsquo;s the achieved result?</span></span></font></font></font></p>
<p style="font-variant: normal; letter-spacing: normal; font-style: normal; font-weight: normal; orphans: 2; widows: 2; margin-left: 1.43cm; margin-right: 1.43cm; margin-bottom: 0.64cm; border: none; padding: 0cm">
<span style="display: inline-block; border: none; padding: 0cm"><font face="inherit"><font size="3" style="font-size: 12pt"><span style="background: #ffffff"><font color="#2b2b2b">Udo
had a command in the z80sim monitor that measured the performance of
the system. The command was still present in my Windows build but
most of the code was commented out (unix functions not available on
vanilla Windows). I changed that with build 0.10. The same
functionality is now included. It works pretty much that same as
Udo&rsquo;s original code; but it uses a thread and a sleep() instead
of unix timers. You can now see how fast your emulation is running.</span></span></font></font></font></p>
<p style="font-variant: normal; letter-spacing: normal; font-style: normal; font-weight: normal; orphans: 2; widows: 2; margin-left: 1.43cm; margin-right: 1.43cm; margin-bottom: 0cm; border: none; padding: 0cm">
<span style="display: inline-block; border: none; padding: 0cm"><font face="inherit"><font size="3" style="font-size: 12pt"><span style="background: #ffffff"><font color="#2b2b2b">On
my newer Win10 laptop I got a little under 80 MHz:<br/>
<font color="#24890d"><u><a href="http://www.sydneysmith.com/wordpress/wp-content/uploads/2018/01/z80sim-unlimited.png">
  <img src="z80sin-clock-speed_html_4a61daa69f45e748.png" name="Image3" align="bottom" width="627" height="338" border="0"/>
</a>
</u></font></span></span></font></font></font></p>
<p style="font-variant: normal; letter-spacing: normal; font-style: normal; font-weight: normal; orphans: 2; widows: 2; margin-left: 1.43cm; margin-right: 1.43cm; margin-bottom: 0.64cm; border: none; padding: 0cm">
<span style="display: inline-block; border: none; padding: 0cm"><font face="inherit"><font size="3" style="font-size: 12pt"><span style="background: #ffffff"><font color="#2b2b2b">That&rsquo;s
not bad at all. The emulation, manually performing all of the steps
needed to mimic a single original instruction, runs 20 times faster
than the real thing!</span></span></font></font></font></p>
<p style="font-variant: normal; letter-spacing: normal; font-style: normal; font-weight: normal; orphans: 2; widows: 2; margin-left: 1.43cm; margin-right: 1.43cm; margin-bottom: 0.64cm; border: none; padding: 0cm">
<span style="display: inline-block; border: none; padding: 0cm"><font face="inherit"><font size="3" style="font-size: 12pt"><span style="background: #ffffff"><font color="#2b2b2b">It
goes even faster on my older Win8.1 laptop (158 MHz, probably a
better processor rather than an OS thing).</span></span></font></font></font></p>
<p style="font-variant: normal; letter-spacing: normal; font-style: normal; font-weight: normal; orphans: 2; widows: 2; margin-left: 1.43cm; margin-right: 1.43cm; margin-bottom: 0.64cm; border: none; padding: 0cm">
<span style="display: inline-block; border: none; padding: 0cm"><font face="inherit"><font size="3" style="font-size: 12pt"><span style="background: #ffffff"><font color="#2b2b2b">The
measurement process is simplistic but it is just as valid as any
other more complicated arbitrary combination of instructions. It
executes jump instructions for three seconds and counts how many
occurred. A jump instruction takes 10 T-states (clock cycles) so the
speed of the CPU clock can be determined: MHz = jump instructions *
10 / 3 seconds.</span></span></font></font></font></p>
<p style="font-variant: normal; letter-spacing: normal; font-style: normal; font-weight: normal; orphans: 2; widows: 2; margin-left: 1.43cm; margin-right: 1.43cm; margin-bottom: 0.64cm; border: none; padding: 0cm">
<span style="display: inline-block; border: none; padding: 0cm"><font face="inherit"><font size="3" style="font-size: 12pt"><span style="background: #ffffff"><font color="#2b2b2b">The
process is destructive &ndash; in that it writes over some memory to
run the timing program &ndash; but the used memory is saved and
restored afterwards, just like in Udo&rsquo;s original. You can
safely do the test and resume a loaded OS and program.</span></span></font></font></font></p>
<p style="line-height: 100%; margin-bottom: 0cm"><br/>

</p>
</body>
</html>